{
  "hash": "b466bc75270dee45667ab06d6011c7d9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Spatial Predictive Analysis: Chicago Graffiti Removal 311 Requests\"\nsubtitle: \"MUSA 5080 Lab Assignment 4\"\nauthor: \"Yanyang Chen\"\ndate: \"2025-11-16\"\nformat:\n  html:\n    toc: true\n    toc-depth: 3\n    code-fold: show\n    self-contained: true\n    theme: cosmo\n    highlight-style: github\neditor: visual\n---\n\n\n\n\n\n# Introduction\n\nGraffiti represents a persistent challenge to urban neighborhoods, affecting aesthetic quality, public safety perceptions, and property values. Chicago's 311 service request system provides a comprehensive record of graffiti removal requests across the city. This analysis applies spatial predictive modeling to understand whether we can forecast graffiti concentrations using spatial features and count regression models.\n\n**Analysis Goals:** - Develop a spatial predictive model using k-nearest neighbor and Local Moran's I features - Compare Poisson and Negative Binomial regression performance - Validate models using spatial cross-validation (Leave-One-Group-Out) - Test temporal stability using 2018 crime data - Evaluate predictive accuracy against kernel density estimation baseline\n\n------------------------------------------------------------------------\n\n# Part 1: Data Loading and Exploration\n\n## Loading Required Libraries\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(sf)\nlibrary(sp)\nlibrary(raster)\nlibrary(spdep)\nlibrary(spatstat)\nlibrary(ggplot2)\nlibrary(gridExtra)\nlibrary(viridis)\nlibrary(MASS)\nlibrary(broom)\nlibrary(jsonlite)\nlibrary(httr)\n\ntheme_set(theme_minimal())\n```\n:::\n\n\n\n## Downloading Graffiti Data from Chicago 311 Portal\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Chicago 311 API endpoint for graffiti data\napi_url <- \"https://data.cityofchicago.org/resource/hec5-y4x5.json\"\n\n# Query parameters: download all available data\nparams <- list(\n  \"$limit\" = 50000\n)\n\n# Execute API request\nresponse <- GET(api_url, query = params)\ngraffiti_raw <- fromJSON(content(response, \"text\"))\ngraffiti_df <- as_tibble(graffiti_raw)\n\ncat(\"Raw Graffiti Data Summary:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRaw Graffiti Data Summary:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Total Records:\", nrow(graffiti_df), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal Records: 50000 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Variables:\", ncol(graffiti_df), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nVariables: 23 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Check available columns\ncat(\"Available columns:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAvailable columns:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(colnames(graffiti_df))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"creation_date\"                           \n [2] \"status\"                                  \n [3] \"completion_date\"                         \n [4] \"service_request_number\"                  \n [5] \"type_of_service_request\"                 \n [6] \"what_type_of_surface_is_the_graffiti_on_\"\n [7] \"where_is_the_graffiti_located_\"          \n [8] \"street_address\"                          \n [9] \"zip_code\"                                \n[10] \"x_coordinate\"                            \n[11] \"y_coordinate\"                            \n[12] \"ward\"                                    \n[13] \"police_district\"                         \n[14] \"community_area\"                          \n[15] \"latitude\"                                \n[16] \"longitude\"                               \n[17] \"location\"                                \n[18] \":@computed_region_awaf_s7ux\"             \n[19] \":@computed_region_6mkv_f3dw\"             \n[20] \":@computed_region_vrxf_vc4k\"             \n[21] \":@computed_region_bdys_3d7i\"             \n[22] \":@computed_region_43wa_7qmu\"             \n[23] \"ssa\"                                     \n```\n\n\n:::\n:::\n\n\n\n## Data Cleaning and Preparation\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Clean and prepare graffiti data\ngraffiti_clean <- graffiti_df %>%\n  filter(!is.na(longitude) & !is.na(latitude)) %>%\n  mutate(\n    longitude = as.numeric(longitude),\n    latitude = as.numeric(latitude),\n    creation_date = as.POSIXct(creation_date),\n    year = year(creation_date),\n    month = month(creation_date),\n    date = as_date(creation_date)\n  ) %>%\n  filter(longitude > -88.5 & longitude < -87.5,\n         latitude > 41.6 & latitude < 42.1)\n\ncat(\"Data Cleaning Summary:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nData Cleaning Summary:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Records after cleaning: \", nrow(graffiti_clean), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRecords after cleaning:  49973 \n```\n\n\n:::\n\n```{.r .cell-code}\nif(nrow(graffiti_clean) > 0) {\n  cat(\"Date range: \", min(graffiti_clean$date, na.rm = TRUE), \n      \" to \", max(graffiti_clean$date, na.rm = TRUE), \"\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDate range:  17709  to  17883 \n```\n\n\n:::\n\n```{.r .cell-code}\nhead(graffiti_clean, 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 26\n  creation_date       status    completion_date         service_request_number\n  <dttm>              <chr>     <chr>                   <chr>                 \n1 2018-12-18 00:00:00 Completed 2018-12-19T00:00:00.000 18-03388768           \n2 2018-12-18 00:00:00 Completed 2018-12-19T00:00:00.000 18-03388476           \n3 2018-12-18 00:00:00 Open      <NA>                    18-03386436           \n4 2018-12-18 00:00:00 Completed 2018-12-19T00:00:00.000 18-03386535           \n5 2018-12-18 00:00:00 Open      <NA>                    18-03388464           \n# ℹ 22 more variables: type_of_service_request <chr>,\n#   what_type_of_surface_is_the_graffiti_on_ <chr>,\n#   where_is_the_graffiti_located_ <chr>, street_address <chr>, zip_code <chr>,\n#   x_coordinate <chr>, y_coordinate <chr>, ward <chr>, police_district <chr>,\n#   community_area <chr>, latitude <dbl>, longitude <dbl>, location <df[,2]>,\n#   `:@computed_region_awaf_s7ux` <chr>, `:@computed_region_6mkv_f3dw` <chr>,\n#   `:@computed_region_vrxf_vc4k` <chr>, `:@computed_region_bdys_3d7i` <chr>, …\n```\n\n\n:::\n:::\n\n\n\n## Converting to Spatial Object\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Convert to sf object (WGS84)\ngraffiti_wgs84 <- st_as_sf(graffiti_clean,\n                            coords = c(\"longitude\", \"latitude\"),\n                            crs = 4326)\n\n# Project to UTM Zone 16N for accurate distance calculations\ngraffiti_utm <- st_transform(graffiti_wgs84, crs = 32616)\n\ncat(\"Spatial Object Created:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSpatial Object Created:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Total features:\", nrow(graffiti_utm), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal features: 49973 \n```\n\n\n:::\n:::\n\n\n\n## Loading Chicago City Boundary\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load Chicago boundary from city's open data portal\nchicago_url <- \"https://data.cityofchicago.org/api/geospatial/igwz-8jzy?method=export&format=GeoJSON\"\nchicago_boundary <- st_read(chicago_url, quiet = TRUE)\n\n# Project to UTM Zone 16N\nchicago_utm <- st_transform(chicago_boundary, crs = 32616)\n\ncat(\"Chicago Boundary Loaded\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nChicago Boundary Loaded\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Area:\", round(as.numeric(st_area(chicago_utm))/1e6, 1), \"km²\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nArea: 4.8 9.1 6 6.6 5.3 8.1 8.2 7.1 2.9 11.3 6 8.3 6.5 5 10.2 8.3 9.6 2.6 10.1 3 5.1 9.3 9.3 11.8 18.5 3.4 5 14.7 8.3 11.9 7.6 4.3 4.6 2.6 4.3 1.6 1.8 4.5 2.7 3.9 4.2 5.4 7.6 7.6 3.2 8.7 1.6 4.5 12.5 5.5 28.2 7.7 9.2 9.1 13.5 10.9 5.2 7 3.7 5.4 12.5 3 5.7 6.6 7.6 9.1 8.2 8 9.2 12.6 9.8 8.2 7.4 7 8.5 34.5 4.5 km²\n```\n\n\n:::\n:::\n\n\n\n## Visualizing Spatial Distribution\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create base map showing all graffiti points\nggplot() +\n  geom_sf(data = chicago_utm, fill = NA, color = \"black\", linewidth = 0.8) +\n  geom_sf(data = graffiti_utm, color = \"#E31C23\", size = 0.8, alpha = 0.3) +\n  theme_minimal() +\n  labs(\n    title = \"Spatial Distribution of Graffiti Removal Requests\",\n    subtitle = paste(\"Total requests:\", nrow(graffiti_utm)),\n    x = \"UTM Easting (m)\",\n    y = \"UTM Northing (m)\"\n  ) +\n  theme(\n    plot.title = element_text(size = 14, face = \"bold\"),\n    plot.subtitle = element_text(size = 11),\n    axis.text = element_text(size = 9)\n  )\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/plot_graffiti_points-1.png){width=3600}\n:::\n:::\n\n\n\n## Temporal Patterns\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate monthly statistics\nmonthly_stats <- graffiti_clean %>%\n  group_by(month) %>%\n  summarise(\n    count = n(),\n    avg_per_day = n() / n_distinct(date),\n    .groups = \"drop\"\n  ) %>%\n  mutate(month_name = month.abb[month])\n\n# Visualize monthly distribution\nggplot(monthly_stats, aes(x = reorder(month_name, month), y = count)) +\n  geom_col(fill = \"#E31C23\", alpha = 0.8, color = \"black\", linewidth = 0.3) +\n  geom_text(aes(label = count), vjust = -0.3, size = 3.5, fontface = \"bold\") +\n  theme_minimal() +\n  labs(\n    title = \"Monthly Distribution of Graffiti Requests\",\n    x = \"Month\",\n    y = \"Number of Requests\"\n  ) +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    plot.title = element_text(size = 13, face = \"bold\")\n  )\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/temporal_analysis-1.png){width=3600}\n:::\n\n```{.r .cell-code}\ncat(\"\\nTemporal Summary:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nTemporal Summary:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(monthly_stats)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 7 × 4\n  month count avg_per_day month_name\n  <dbl> <int>       <dbl> <chr>     \n1     6  1337        334. Jun       \n2     7 10078        325. Jul       \n3     8 10098        326. Aug       \n4     9  8033        268. Sep       \n5    10  8808        284. Oct       \n6    11  7733        258. Nov       \n7    12  3886        216. Dec       \n```\n\n\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n# Part 2: Fishnet Grid Creation\n\n## Creating 500m × 500m Grid\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create regular grid covering Chicago\nfishnet_full <- st_make_grid(\n  chicago_utm,\n  cellsize = 500,\n  square = TRUE,\n  what = \"polygons\"\n) %>%\n  st_as_sf() %>%\n  mutate(grid_id = row_number())\n\n# Keep only grid cells intersecting Chicago boundary\nfishnet_chicago <- fishnet_full[chicago_utm, ]\n\ncat(\"Fishnet Grid Created:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFishnet Grid Created:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Total grid cells:\", nrow(fishnet_chicago), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal grid cells: 2618 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Cell size: 500m × 500m\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCell size: 500m × 500m\n```\n\n\n:::\n:::\n\n\n\n## Aggregating Graffiti Counts to Grid\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Aggregate graffiti points to grid cells\ngraffiti_grid <- fishnet_chicago %>%\n  st_join(graffiti_utm, join = st_contains) %>%\n  group_by(grid_id) %>%\n  summarise(\n    n_graffiti = n(),\n    .groups = \"drop\"\n  ) %>%\n  mutate(n_graffiti = ifelse(is.na(n_graffiti), 0, n_graffiti))\n\ncat(\"Grid Aggregation Complete:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nGrid Aggregation Complete:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Total cells:\", nrow(graffiti_grid), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal cells: 2618 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Cells with graffiti:\", sum(graffiti_grid$n_graffiti > 0), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCells with graffiti: 2618 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Mean per cell:\", round(mean(graffiti_grid$n_graffiti), 2), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean per cell: 19.47 \n```\n\n\n:::\n\n```{.r .cell-code}\nprint(summary(graffiti_grid$n_graffiti))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   1.00    1.00    3.00   19.47   18.00  403.00 \n```\n\n\n:::\n:::\n\n\n\n## Visualizing Grid Aggregation\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Map showing graffiti counts per grid cell\np1 <- ggplot() +\n  geom_sf(data = graffiti_grid, aes(fill = n_graffiti), color = NA) +\n  geom_sf(data = chicago_utm, fill = NA, color = \"black\", linewidth = 0.5) +\n  scale_fill_viridis_c(name = \"Requests\", option = \"plasma\") +\n  theme_minimal() +\n  labs(\n    title = \"Graffiti Count Aggregation to 500m Grid\",\n    x = \"UTM Easting (m)\",\n    y = \"UTM Northing (m)\"\n  ) +\n  theme(plot.title = element_text(size = 13, face = \"bold\"))\n\n# Histogram of counts\np2 <- ggplot(graffiti_grid, aes(x = n_graffiti)) +\n  geom_histogram(bins = 40, fill = \"#E31C23\", alpha = 0.8, color = \"black\") +\n  theme_minimal() +\n  labs(\n    title = \"Distribution of Graffiti Counts\",\n    x = \"Requests per Cell\",\n    y = \"Frequency\"\n  ) +\n  theme(plot.title = element_text(size = 12, face = \"bold\"))\n\ngridExtra::grid.arrange(p1, p2, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/plot_grid_distribution-1.png){width=4200}\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n# Part 3: Spatial Features Construction\n\n## Creating Spatial Weights Matrix and Features\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 1: Ensure graffiti_grid is sf with grid_id\ngraffiti_grid <- graffiti_grid %>%\n  mutate(grid_id = row_number())\n\n# Step 2: Convert to sp object (required by spdep)\ngraffiti_sp <- as_Spatial(graffiti_grid)\n\n# Step 3: Create k-nearest neighbors weight matrix\nknn_neighbors <- knearneigh(coordinates(graffiti_sp), k = 5)\nknn_weights <- knn2nb(knn_neighbors, sym = TRUE)\nknn_weights_std <- nb2listw(knn_weights, style = \"W\")\n\ncat(\"Spatial Weights Matrix Created (k=5 nearest neighbors)\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSpatial Weights Matrix Created (k=5 nearest neighbors)\n```\n\n\n:::\n\n```{.r .cell-code}\n# Step 4: Calculate k-NN feature (neighbor mean)\nneighbor_lags <- lag.listw(knn_weights_std, graffiti_grid$n_graffiti)\n\n# Step 5: Calculate Local Moran's I\nlocal_moran <- localmoran(graffiti_grid$n_graffiti, knn_weights_std)\n\n# Step 6: Calculate distance to hotspot\nhotspot_threshold <- quantile(graffiti_grid$n_graffiti, 0.75)\nhotspots <- graffiti_grid %>% filter(n_graffiti >= hotspot_threshold)\nhotspot_center <- st_centroid(st_union(hotspots))\ndist_to_hotspot <- as.numeric(st_distance(graffiti_grid, hotspot_center)) / 1000\n\n# Step 7: Add all features to graffiti_grid\ngraffiti_grid <- graffiti_grid %>%\n  mutate(\n    neighbor_mean = neighbor_lags,\n    local_i = local_moran[, 1],\n    local_i_pval = local_moran[, 5],\n    dist_to_hotspot = dist_to_hotspot,\n    moran_cluster = case_when(\n      local_i_pval >= 0.05 ~ \"Not significant\",\n      local_i >= 0 & n_graffiti >= median(n_graffiti) ~ \"High-High\",\n      local_i >= 0 & n_graffiti < median(n_graffiti) ~ \"Low-Low\",\n      local_i < 0 & n_graffiti >= median(n_graffiti) ~ \"High-Low\",\n      TRUE ~ \"Low-High\"\n    )\n  )\n\ncat(\"\\nSpatial Features Added:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nSpatial Features Added:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"neighbor_mean: Average graffiti count in 5 nearest neighbors\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nneighbor_mean: Average graffiti count in 5 nearest neighbors\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"local_i: Local Moran's I statistic\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nlocal_i: Local Moran's I statistic\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"dist_to_hotspot: Distance to graffiti hotspot (km)\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ndist_to_hotspot: Distance to graffiti hotspot (km)\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"moran_cluster: Classification of spatial clusters\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nmoran_cluster: Classification of spatial clusters\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nFirst 5 rows:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nFirst 5 rows:\n```\n\n\n:::\n\n```{.r .cell-code}\nfeature_summary <- graffiti_grid %>% \n  st_drop_geometry()\n\nhead(feature_summary, 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 7\n  grid_id n_graffiti neighbor_mean local_i local_i_pval dist_to_hotspot\n    <int>      <int>         <dbl>   <dbl>        <dbl>           <dbl>\n1       1          1             1   0.200        0.317            27.9\n2       2          1             1   0.200        0.317            28.0\n3       3          1             1   0.200        0.273            28.1\n4       4          1             1   0.200        0.317            28.2\n5       5          1             1   0.200        0.317            28.3\n# ℹ 1 more variable: moran_cluster <chr>\n```\n\n\n:::\n:::\n\n\n\n## Visualizing Hotspots and Coldspots\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = graffiti_grid, aes(fill = moran_cluster), color = NA) +\n  geom_sf(data = chicago_utm, fill = NA, color = \"black\", linewidth = 0.5) +\n  scale_fill_manual(\n    name = \"Cluster Type\",\n    values = c(\n      \"High-High\" = \"#d73027\",\n      \"Low-Low\" = \"#91bfdb\",\n      \"High-Low\" = \"#fee090\",\n      \"Low-High\" = \"#a6d96a\",\n      \"Not significant\" = \"#f7f7f7\"\n    )\n  ) +\n  theme_minimal() +\n  labs(\n    title = \"Local Moran's I: Graffiti Hotspots and Coldspots\",\n    x = \"UTM Easting (m)\",\n    y = \"UTM Northing (m)\"\n  ) +\n  theme(plot.title = element_text(size = 13, face = \"bold\"))\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/plot_local_morans-1.png){width=3600}\n:::\n\n```{.r .cell-code}\ncat(\"\\nCluster Distribution:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCluster Distribution:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(table(graffiti_grid$moran_cluster))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n      High-High        High-Low        Low-High Not significant \n            304              20               2            2292 \n```\n\n\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n# Part 4: Count Regression Models\n\n## Preparing Data for Modeling\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prepare data for modeling\nmodel_data <- graffiti_grid %>%\n  st_drop_geometry() %>%\n  na.omit()\n\ncat(\"Model Data Prepared:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nModel Data Prepared:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Sample size:\", nrow(model_data), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSample size: 2618 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Dependent variable (n_graffiti):\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDependent variable (n_graffiti):\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(summary(model_data$n_graffiti))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   1.00    1.00    3.00   19.47   18.00  403.00 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nOverdispersion check:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nOverdispersion check:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Mean:\", mean(model_data$n_graffiti), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean: 19.46639 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Variance:\", var(model_data$n_graffiti), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nVariance: 1706.421 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Variance/Mean ratio:\", round(var(model_data$n_graffiti)/mean(model_data$n_graffiti), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nVariance/Mean ratio: 87.66 \n```\n\n\n:::\n:::\n\n\n\n## Poisson Regression\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit Poisson regression\npoisson_model <- glm(\n  n_graffiti ~ neighbor_mean + local_i + dist_to_hotspot,\n  family = poisson(link = \"log\"),\n  data = model_data\n)\n\ncat(\"POISSON REGRESSION RESULTS\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPOISSON REGRESSION RESULTS\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(strrep(\"=\", 50), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n================================================== \n```\n\n\n:::\n\n```{.r .cell-code}\nprint(summary(poisson_model))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = n_graffiti ~ neighbor_mean + local_i + dist_to_hotspot, \n    family = poisson(link = \"log\"), data = model_data)\n\nCoefficients:\n                  Estimate Std. Error z value Pr(>|z|)    \n(Intercept)      3.3068979  0.0126373  261.68   <2e-16 ***\nneighbor_mean    0.0121075  0.0001187  101.97   <2e-16 ***\nlocal_i          0.0780056  0.0009253   84.30   <2e-16 ***\ndist_to_hotspot -0.0971570  0.0010339  -93.97   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for poisson family taken to be 1)\n\n    Null deviance: 119805  on 2617  degrees of freedom\nResidual deviance:  36856  on 2614  degrees of freedom\nAIC: 45856\n\nNumber of Fisher Scoring iterations: 5\n```\n\n\n:::\n\n```{.r .cell-code}\n# Extract metrics\npoisson_aic <- AIC(poisson_model)\npoisson_deviance <- deviance(poisson_model)\npoisson_dispersion <- poisson_deviance / df.residual(poisson_model)\n\ncat(\"\\nModel Fit Statistics:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nModel Fit Statistics:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"AIC:\", round(poisson_aic, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAIC: 45856.21 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Dispersion statistic:\", round(poisson_dispersion, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDispersion statistic: 14.099 \n```\n\n\n:::\n:::\n\n\n\n## Negative Binomial Regression\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fit Negative Binomial regression\nnb_model <- glm.nb(\n  n_graffiti ~ neighbor_mean + local_i + dist_to_hotspot,\n  data = model_data\n)\n\ncat(\"\\nNEGATIVE BINOMIAL REGRESSION RESULTS\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nNEGATIVE BINOMIAL REGRESSION RESULTS\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(strrep(\"=\", 50), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n================================================== \n```\n\n\n:::\n\n```{.r .cell-code}\nprint(summary(nb_model))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm.nb(formula = n_graffiti ~ neighbor_mean + local_i + dist_to_hotspot, \n    data = model_data, init.theta = 1.254353791, link = log)\n\nCoefficients:\n                  Estimate Std. Error z value Pr(>|z|)    \n(Intercept)      2.4862158  0.0557367  44.606   <2e-16 ***\nneighbor_mean    0.0326243  0.0008968  36.378   <2e-16 ***\nlocal_i         -0.0161810  0.0121606  -1.331    0.183    \ndist_to_hotspot -0.0826818  0.0034258 -24.135   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for Negative Binomial(1.2544) family taken to be 1)\n\n    Null deviance: 8149.6  on 2617  degrees of freedom\nResidual deviance: 2538.9  on 2614  degrees of freedom\nAIC: 16295\n\nNumber of Fisher Scoring iterations: 1\n\n              Theta:  1.2544 \n          Std. Err.:  0.0385 \n\n 2 x log-likelihood:  -16285.0510 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Extract metrics\nnb_aic <- AIC(nb_model)\nnb_deviance <- deviance(nb_model)\n\ncat(\"\\nModel Fit Statistics:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nModel Fit Statistics:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"AIC:\", round(nb_aic, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAIC: 16295.05 \n```\n\n\n:::\n:::\n\n\n\n## Model Comparison\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compare models\ncat(\"\\nMODEL COMPARISON\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nMODEL COMPARISON\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(strrep(\"=\", 50), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n================================================== \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Poisson AIC:\", round(poisson_aic, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPoisson AIC: 45856.21 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Negative Binomial AIC:\", round(nb_aic, 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNegative Binomial AIC: 16295.05 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Difference:\", round(poisson_aic - nb_aic, 2), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDifference: 29561.15 \n```\n\n\n:::\n\n```{.r .cell-code}\nif (nb_aic < poisson_aic) {\n  cat(\"Decision: Negative Binomial model preferred (lower AIC)\\n\")\n  selected_model <- nb_model\n  model_name <- \"Negative Binomial\"\n} else {\n  cat(\"Decision: Poisson model preferred (lower AIC)\\n\")\n  selected_model <- poisson_model\n  model_name <- \"Poisson\"\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDecision: Negative Binomial model preferred (lower AIC)\n```\n\n\n:::\n\n```{.r .cell-code}\n# Extract coefficients\ncoef_table <- tidy(selected_model, exponentiate = TRUE, conf.int = TRUE)\n\ncat(\"\\n\\nSelected Model Coefficients (Exponentiated - Incidence Rate Ratios):\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\nSelected Model Coefficients (Exponentiated - Incidence Rate Ratios):\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(coef_table)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 7\n  term            estimate std.error statistic   p.value conf.low conf.high\n  <chr>              <dbl>     <dbl>     <dbl>     <dbl>    <dbl>     <dbl>\n1 (Intercept)       12.0    0.0557       44.6  0           10.6      13.6  \n2 neighbor_mean      1.03   0.000897     36.4  9.44e-290    1.03      1.04 \n3 local_i            0.984  0.0122       -1.33 1.83e-  1    0.960     1.01 \n4 dist_to_hotspot    0.921  0.00343     -24.1  1.07e-128    0.914     0.927\n```\n\n\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n# Part 5: Spatial Cross-Validation\n\n## Setting Up Spatial Folds\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create spatial folds\nset.seed(123)\nn_folds <- 5\n\ncentroids <- st_coordinates(st_centroid(graffiti_grid))\nspatial_folds <- kmeans(centroids, centers = n_folds)$cluster\n\ncv_data <- model_data %>%\n  mutate(fold = spatial_folds[row_number()])\n\ncat(\"Spatial Cross-Validation Setup:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSpatial Cross-Validation Setup:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Number of folds:\", n_folds, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNumber of folds: 5 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Fold sizes:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFold sizes:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(table(cv_data$fold))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  1   2   3   4   5 \n497 331 505 610 675 \n```\n\n\n:::\n:::\n\n\n\n## Running Cross-Validation\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Cross-validation loop\ncv_results <- tibble()\n\nfor (fold_num in 1:n_folds) {\n  train_data <- cv_data %>% filter(fold != fold_num)\n  test_data <- cv_data %>% filter(fold == fold_num)\n  \n  # Fit model on training data\n  if (model_name == \"Negative Binomial\") {\n    fold_model <- glm.nb(\n      n_graffiti ~ neighbor_mean + local_i + dist_to_hotspot,\n      data = train_data\n    )\n  } else {\n    fold_model <- glm(\n      n_graffiti ~ neighbor_mean + local_i + dist_to_hotspot,\n      family = poisson(link = \"log\"),\n      data = train_data\n    )\n  }\n  \n  # Predictions\n  pred <- predict(fold_model, newdata = test_data, type = \"response\")\n  \n  fold_results <- test_data %>%\n    mutate(\n      fold = fold_num,\n      observed = n_graffiti,\n      predicted = pred,\n      error = observed - predicted,\n      abs_error = abs(error),\n      squared_error = error^2\n    )\n  \n  cv_results <- bind_rows(cv_results, fold_results)\n}\n\ncat(\"Cross-Validation Complete:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCross-Validation Complete:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Total predictions:\", nrow(cv_results), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal predictions: 2618 \n```\n\n\n:::\n:::\n\n\n\n## Cross-Validation Error Metrics\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate error metrics\nmae <- mean(cv_results$abs_error, na.rm = TRUE)\nrmse <- sqrt(mean(cv_results$squared_error, na.rm = TRUE))\nme <- mean(cv_results$error, na.rm = TRUE)\n\ncat(\"SPATIAL CROSS-VALIDATION RESULTS\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSPATIAL CROSS-VALIDATION RESULTS\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(strrep(\"=\", 50), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n================================================== \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Mean Absolute Error (MAE):\", round(mae, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean Absolute Error (MAE): 44.017 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Root Mean Squared Error (RMSE):\", round(rmse, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRoot Mean Squared Error (RMSE): 383.165 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Mean Error (ME):\", round(me, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMean Error (ME): -33.302 \n```\n\n\n:::\n:::\n\n\n\n## Visualizing CV Results\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Observed vs Predicted\np1 <- ggplot(cv_results, aes(x = observed, y = predicted)) +\n  geom_point(alpha = 0.5, color = \"#E31C23\") +\n  geom_abline(intercept = 0, slope = 1, color = \"blue\", linetype = \"dashed\") +\n  theme_minimal() +\n  labs(\n    title = \"Spatial CV: Observed vs Predicted\",\n    x = \"Observed\",\n    y = \"Predicted\",\n    subtitle = paste(\"MAE =\", round(mae, 2))\n  ) +\n  theme(plot.title = element_text(size = 12, face = \"bold\"))\n\n# Residuals\np2 <- ggplot(cv_results, aes(x = error)) +\n  geom_histogram(bins = 30, fill = \"#E31C23\", alpha = 0.7) +\n  geom_vline(xintercept = 0, color = \"blue\", linetype = \"dashed\") +\n  theme_minimal() +\n  labs(\n    title = \"Residuals Distribution\",\n    x = \"Prediction Error\",\n    y = \"Frequency\"\n  ) +\n  theme(plot.title = element_text(size = 12, face = \"bold\"))\n\ngridExtra::grid.arrange(p1, p2, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/plot_cv_results-1.png){width=4200}\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n# Part 6: Temporal Validation (2018 Data)\n\n## Loading 2018 Crime Data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Download 2018 crimes data\ncrime_url <- \"https://data.cityofchicago.org/resource/3i3m-jwuy.json\"\n\n# Simple query without complex filters\nresponse_2018 <- GET(crime_url, query = list(\"$limit\" = 50000))\ncrime_2018_raw <- fromJSON(content(response_2018, \"text\"))\ncrime_2018_df <- as_tibble(crime_2018_raw)\n\ncat(\"2018 Crime Data Loaded:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n2018 Crime Data Loaded:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Total records:\", nrow(crime_2018_df), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal records: 50000 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Columns:\", ncol(crime_2018_df), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nColumns: 22 \n```\n\n\n:::\n:::\n\n\n\n## Preparing 2018 Data\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Clean 2018 data\ncrime_2018_clean <- crime_2018_df %>%\n  filter(!is.na(longitude) & !is.na(latitude)) %>%\n  mutate(\n    longitude = as.numeric(longitude),\n    latitude = as.numeric(latitude)\n  ) %>%\n  filter(longitude > -88.5 & longitude < -87.5,\n         latitude > 41.6 & latitude < 42.1)\n\n# Convert to sf\ncrime_2018_wgs84 <- st_as_sf(crime_2018_clean,\n                             coords = c(\"longitude\", \"latitude\"),\n                             crs = 4326)\n\ncrime_2018_utm <- st_transform(crime_2018_wgs84, crs = 32616)\n\ncat(\"2018 Data Cleaned:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n2018 Data Cleaned:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Records:\", nrow(crime_2018_utm), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRecords: 48166 \n```\n\n\n:::\n:::\n\n\n\n## Aggregating 2018 to Same Grid\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Aggregate to grid\ncrime_2018_grid <- fishnet_chicago %>%\n  st_join(crime_2018_utm, join = st_contains) %>%\n  group_by(grid_id) %>%\n  summarise(\n    n_crime = n(),\n    .groups = \"drop\"\n  ) %>%\n  mutate(n_crime = ifelse(is.na(n_crime), 0, n_crime))\n\ncat(\"2018 Aggregation:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n2018 Aggregation:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Total cells:\", nrow(crime_2018_grid), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal cells: 2618 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Cells with crimes:\", sum(crime_2018_grid$n_crime > 0), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCells with crimes: 2618 \n```\n\n\n:::\n:::\n\n\n\n## Predicting 2018 with 2017 Model\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prepare features\ncrime_2018_features <- crime_2018_grid %>%\n  st_drop_geometry() %>%\n  mutate(\n    observed_2018 = n_crime\n  ) %>%\n  left_join(\n    model_data %>% mutate(grid_id = row_number()),\n    by = \"grid_id\"\n  ) %>%\n  na.omit()\n\ncat(\"2018 Features Prepared:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n2018 Features Prepared:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Records:\", nrow(crime_2018_features), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRecords: 1186 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Make predictions using 2017 model\npred_2018 <- predict(selected_model, \n                     newdata = crime_2018_features, \n                     type = \"response\")\n\ntemporal_results <- crime_2018_features %>%\n  mutate(\n    predicted_2018 = pred_2018,\n    error_2018 = observed_2018 - predicted_2018,\n    abs_error_2018 = abs(error_2018),\n    squared_error_2018 = error_2018^2\n  )\n\ncat(\"Temporal Validation:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTemporal Validation:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Predictions made:\", nrow(temporal_results), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPredictions made: 1186 \n```\n\n\n:::\n:::\n\n\n\n## Temporal Validation Metrics\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate 2018 metrics\nmae_2018 <- mean(temporal_results$abs_error_2018)\nrmse_2018 <- sqrt(mean(temporal_results$squared_error_2018))\n\ncat(\"TEMPORAL VALIDATION (2018)\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTEMPORAL VALIDATION (2018)\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(strrep(\"=\", 50), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n================================================== \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"MAE:\", round(mae_2018, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMAE: 41.618 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"RMSE:\", round(rmse_2018, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRMSE: 201.111 \n```\n\n\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n# Part 7: KDE Baseline Comparison\n\n## Calculating KDE Baseline\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create point pattern\ngraffiti_coords <- st_coordinates(graffiti_utm)\n\n# Create window\nwindow <- owin(xrange = range(graffiti_coords[, 1]),\n               yrange = range(graffiti_coords[, 2]))\n\n# Create point pattern\ngraffiti_ppp <- ppp(x = graffiti_coords[, 1],\n                    y = graffiti_coords[, 2],\n                    window = window)\n\n# Calculate KDE\nkde_2017 <- density(graffiti_ppp, sigma = bw.diggle(graffiti_ppp))\nkde_raster <- raster(kde_2017)\n\n# Extract to grid\ngrid_centroids <- st_centroid(graffiti_grid)\nkde_values <- raster::extract(kde_raster, as_Spatial(grid_centroids))\n\n# Normalize\nkde_grid_counts <- kde_values * (500 * 500) / sum(kde_values, na.rm = TRUE) * \n                   sum(graffiti_grid$n_graffiti)\n\n# Calculate errors\nkde_errors <- graffiti_grid %>%\n  st_drop_geometry() %>%\n  mutate(\n    predicted_kde = kde_grid_counts,\n    error_kde = n_graffiti - predicted_kde,\n    abs_error_kde = abs(error_kde),\n    squared_error_kde = error_kde^2\n  ) %>%\n  na.omit()\n\nmae_kde <- mean(kde_errors$abs_error_kde)\nrmse_kde <- sqrt(mean(kde_errors$squared_error_kde))\n\ncat(\"KDE BASELINE\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nKDE BASELINE\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(strrep(\"=\", 50), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n================================================== \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"MAE:\", round(mae_kde, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMAE: 5204537 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"RMSE:\", round(rmse_kde, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRMSE: 13632995 \n```\n\n\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n# Part 8: Final Model Comparison\n\n## Comprehensive Comparison\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compare all methods\ncomparison <- tibble(\n  Method = c(\n    paste(\"Spatial CV -\", model_name),\n    \"Temporal (2018)\",\n    \"KDE Baseline\"\n  ),\n  MAE = c(mae, mae_2018, mae_kde),\n  RMSE = c(rmse, rmse_2018, rmse_kde)\n)\n\ncat(\"FINAL MODEL COMPARISON\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFINAL MODEL COMPARISON\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(strrep(\"=\", 50), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n================================================== \n```\n\n\n:::\n\n```{.r .cell-code}\nprint(comparison)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 3\n  Method                               MAE      RMSE\n  <chr>                              <dbl>     <dbl>\n1 Spatial CV - Negative Binomial      44.0      383.\n2 Temporal (2018)                     41.6      201.\n3 KDE Baseline                   5204537.  13632995.\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nImprovement Over KDE Baseline:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nImprovement Over KDE Baseline:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Spatial CV:\", round((1 - mae/mae_kde)*100, 1), \"%\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSpatial CV: 100 %\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Temporal:\", round((1 - mae_2018/mae_kde)*100, 1), \"%\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTemporal: 100 %\n```\n\n\n:::\n\n```{.r .cell-code}\n# Visualize comparison\ncomparison_long <- comparison %>%\n  pivot_longer(cols = c(MAE, RMSE), names_to = \"Metric\", values_to = \"Value\")\n\nggplot(comparison_long, aes(x = Method, y = Value, fill = Metric)) +\n  geom_col(position = \"dodge\", alpha = 0.8, color = \"black\") +\n  geom_text(aes(label = round(Value, 2)), position = position_dodge(width = 0.9), \n            vjust = -0.3, size = 3.5) +\n  theme_minimal() +\n  labs(\n    title = \"Final Model Comparison: Error Metrics\",\n    y = \"Error (lower is better)\"\n  ) +\n  scale_fill_brewer(palette = \"Set2\") +\n  theme(\n    plot.title = element_text(size = 13, face = \"bold\"),\n    axis.text.x = element_text(angle = 30, hjust = 1)\n  )\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/final_comparison-1.png){width=3600}\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n# Part 9: Error Analysis and Performance Mapping\n\n## Mapping Prediction Errors\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Add predictions back to grid\ngraffiti_grid_errors <- graffiti_grid %>%\n  left_join(\n    cv_results %>%\n      group_by(grid_id) %>%\n      summarise(\n        predicted = mean(predicted, na.rm = TRUE),\n        error = mean(error, na.rm = TRUE),\n        abs_error = mean(abs_error, na.rm = TRUE),\n        .groups = \"drop\"\n      ),\n    by = \"grid_id\"\n  )\n\n# Map absolute errors\np1 <- ggplot() +\n  geom_sf(data = graffiti_grid_errors, aes(fill = abs_error), color = NA) +\n  geom_sf(data = chicago_utm, fill = NA, color = \"black\", linewidth = 0.5) +\n  scale_fill_viridis_c(name = \"Absolute Error\", option = \"magma\", na.value = \"white\") +\n  theme_minimal() +\n  labs(\n    title = \"Geographic Distribution of Absolute Prediction Errors\",\n    x = \"UTM Easting (m)\",\n    y = \"UTM Northing (m)\"\n  ) +\n  theme(plot.title = element_text(size = 12, face = \"bold\"))\n\n# Map signed errors\np2 <- ggplot() +\n  geom_sf(data = graffiti_grid_errors, aes(fill = error), color = NA) +\n  geom_sf(data = chicago_utm, fill = NA, color = \"black\", linewidth = 0.5) +\n  scale_fill_distiller(\n    name = \"Error\",\n    type = \"div\",\n    palette = \"RdBu\",\n    na.value = \"white\"\n  ) +\n  theme_minimal() +\n  labs(\n    title = \"Signed Errors: Red=Underpredicted, Blue=Overpredicted\",\n    x = \"UTM Easting (m)\",\n    y = \"UTM Northing (m)\"\n  ) +\n  theme(plot.title = element_text(size = 12, face = \"bold\"))\n\ngridExtra::grid.arrange(p1, p2, ncol = 2)\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/error_mapping-1.png){width=4200}\n:::\n:::\n\n\n\n## Performance by Observed Count Level\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Analyze error patterns\nerror_by_count <- cv_results %>%\n  mutate(count_bin = cut(observed, \n                        breaks = c(-Inf, 0, 5, 10, 20, Inf),\n                        labels = c(\"0\", \"1-5\", \"6-10\", \"11-20\", \"20+\"))) %>%\n  group_by(count_bin) %>%\n  summarise(\n    n = n(),\n    MAE = mean(abs_error, na.rm = TRUE),\n    RMSE = sqrt(mean(squared_error, na.rm = TRUE)),\n    .groups = \"drop\"\n  )\n\ncat(\"Error Metrics by Observed Count Level:\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nError Metrics by Observed Count Level:\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(error_by_count)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 4\n  count_bin     n    MAE  RMSE\n  <fct>     <int>  <dbl> <dbl>\n1 1-5        1543   3.33  12.2\n2 6-10        247  22.5  188. \n3 11-20       205  71.9  871. \n4 20+         623 144.   594. \n```\n\n\n:::\n\n```{.r .cell-code}\nggplot(error_by_count, aes(x = count_bin)) +\n  geom_col(aes(y = MAE), fill = \"#E31C23\", alpha = 0.7) +\n  geom_point(aes(y = RMSE), color = \"#0073C2\", size = 4) +\n  theme_minimal() +\n  labs(\n    title = \"Prediction Error by Observed Graffiti Count Level\",\n    x = \"Observed Count Range\",\n    y = \"Error Metric\",\n    subtitle = \"Bars = MAE | Points = RMSE\"\n  ) +\n  theme(plot.title = element_text(size = 12, face = \"bold\"))\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/performance_by_count-1.png){width=4200}\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n# Summary and Conclusions\n\n## Key Findings\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncat(\"ANALYSIS SUMMARY\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nANALYSIS SUMMARY\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(strrep(\"=\", 50), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n================================================== \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"1. DATA OVERVIEW\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n1. DATA OVERVIEW\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • Graffiti requests analyzed:\", nrow(graffiti_utm), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Graffiti requests analyzed: 49973 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • Grid cells created:\", nrow(graffiti_grid), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Grid cells created: 2618 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • Cells with graffiti:\", sum(graffiti_grid$n_graffiti > 0), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Cells with graffiti: 2618 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"2. SPATIAL PATTERNS\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n2. SPATIAL PATTERNS\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • Significant clusters identified:\", \n    sum(graffiti_grid$local_i_pval < 0.05), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Significant clusters identified: 326 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • Hotspot areas (High-High):\", \n    sum(graffiti_grid$moran_cluster == \"High-High\"), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Hotspot areas (High-High): 304 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • Coldspot areas (Low-Low):\", \n    sum(graffiti_grid$moran_cluster == \"Low-Low\"), \"\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Coldspot areas (Low-Low): 0 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"3. MODEL PERFORMANCE\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n3. MODEL PERFORMANCE\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • Selected model:\", model_name, \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Selected model: Negative Binomial \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • Spatial CV MAE:\", round(mae, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Spatial CV MAE: 44.017 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • Spatial CV RMSE:\", round(rmse, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Spatial CV RMSE: 383.165 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • Improvement over KDE:\", round((1 - mae/mae_kde)*100, 1), \"%\\n\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Improvement over KDE: 100 %\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"4. TEMPORAL STABILITY\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n4. TEMPORAL STABILITY\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"   • 2018 predictions MAE:\", round(mae_2018, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • 2018 predictions MAE: 41.618 \n```\n\n\n:::\n\n```{.r .cell-code}\nif (mae_2018 < mae * 1.3) {\n  cat(\"   • Model shows good temporal stability\\n\")\n} else {\n  cat(\"   • Model shows temporal degradation\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • Model shows good temporal stability\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\n5. SPATIAL FEATURES IMPORTANCE\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n5. SPATIAL FEATURES IMPORTANCE\n```\n\n\n:::\n\n```{.r .cell-code}\nfor (i in 2:nrow(coef_table)) {\n  term <- coef_table$term[i]\n  irr <- coef_table$estimate[i]\n  pval <- coef_table$p.value[i]\n  sig <- ifelse(pval < 0.05, \"***\", \"\")\n  cat(\"   •\", term, \"(IRR =\", round(irr, 3), \") \", sig, \"\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   • neighbor_mean (IRR = 1.033 )  *** \n   • local_i (IRR = 0.984 )   \n   • dist_to_hotspot (IRR = 0.921 )  *** \n```\n\n\n:::\n:::\n\n\n\n------------------------------------------------------------------------\n\n**Report Generated:** 2025-11-16 01:37:30\n\n**Course:** MUSA 5080 - Public Policy Analytics\\\n**Assignment:** Lab 4 - Spatial Predictive Analysis\\\n**Institution:** University of Pennsylvania\n",
    "supporting": [
      "assignment4_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}